<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Лаба 1</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <style>
        body, button     {
            text-align: center;
            padding: 10px;
            border: 2px groove coral;
            color: blue;
            line-height: 1.4;
            font-size: 13px; 
        }
        @media (max-width: 800px) {
        body, button {
            font-size: 10px; 
        }
}
        header {
            font-family: serif;
            color: darkred;
            font-size: larger;
        }

        header a {
            color: inherit;      
            text-decoration: none; 
        }

        header > p {
            margin: 3px;
        }

        .fio::before{
            content: "ℹ️";
        }

        table {
            border: 1px solid cadetblue;
            width: 100%;
            min-width: 300px;
            min-height: 100px;
        }
        
        th {
            background-color: rgba(252, 225, 225, 0.8); 
            font-weight: bold;
            border: 1px solid #333;
            padding: 12px;
            text-align: center;
        }

        td {
            background-color: rgba(255, 255, 255, 0.7); 
            border: 1px solid #333;
            padding: 12px;
            text-align: center;
        }

        button:hover{
            background-color: bisque;
            transform: scale(110%);
            font-style: italic;
        }

        input, select, button {
            padding: 1%; 
            margin: 1%;
        }

        button {
            width: 40%;
            height: 5%;
        }

        .error {
            border: 2px solid red;
            background-color: #ffe6e6;
        }

        input[type="radio"].error {
            outline: 2px solid red;
            box-shadow: 0 0 5px red;
        }

        input[type="radio"].error + label {
            color: red;
        }
        .form-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }
        
        canvas
        {
            border: 1px solid black;
            background-color: #f0f8ff;
            width: 200px;
            height: 200px;
        }
    </style>
</head>
<body>  
    <header>
        <p>Лабораторная работа №1<p>
        <p class="fio"> 
            <a href="https://my.itmo.ru/persons/466207?p=1&q=%D0%BA%D0%BE%D0%B2%D1%8B%D1%80%D1%88%D0%B8%D0%BD">Ковыршин Александр Сергеевич </a>
        </p>
        <p>P3217</p>
        <p>Вариант 466207</p>        
    </header>

    <div class = "form-container"> 
    <table> 
       
        <tr>
            <td colspan="3"> 
                <svg id="graph" width="200" height="200" style="border:1px solid black; background-color:#f0f8ff;"></svg>
            </td>
            <td colspan="3"> 
                <form method="post" action="/" id="mainForm">
                    <div>
                        <label for = "inputX">Выберите X:</label>
                        <select name="x" id = "inputX">
                            <option value="-2">-2</option>
                            <option value="-1.5">-1.5</option>
                            <option value="-1">-1</option>
                            <option value="-0.5">-0.5</option>
                            <option value="0">0</option>
                            <option value="0.5">0.5</option>
                            <option value="1">1</option>
                            <option value="1.5">1.5</option>
                            <option value="2">2</option>
                        </select>
                    </div>
                    <div>
                        <label for = "inputY">Введите Y:</label>
                        <input type="text" name="y" placeholder="{-5..5}" id="inputY">
                    </div>
                    Выберите R:
                    <div>
                        <input type="radio" name="r" value="1" id="r1">
                        <label for="r1">1</label>
                        
                        <input type="radio" name="r" value="2" id="r2">
                        <label for="r2">2</label>
                        
                        <input type="radio" name="r" value="3" id="r3">
                        <label for="r3">3</label>
                        
                        <input type="radio" name="r" value="4" id="r4">
                        <label for="r4">4</label>
                        
                        <input type="radio" name="r" value="5" id="r5">
                        <label for="r5">5</label>
                    </div>
                    <div>
                        <button type="submit" id = 'submitButton'>Проверить попадание</button>
                    </div>
                    <div>
                        <button type="button" id = 'clearButton'>Очистить таблицы</button>
                    </div>
                </form>
            </td>
        </tr>
        
        <tr>    
            <th>X</th>
            <th>Y</th>
            <th>R</th>
            <th>Попал?</th>
            <th>Текущее время</th>
            <th>Время работы</th>
        </tr>

        <tbody id="resultsBody">
        </tbody>
</table>
</div>
    <script> 
        toastr.options = {
            "closeButton": true,
            "progressBar": true,
            "positionClass": "toast-top-right",
            "timeOut": "2000"
        };
        const xSelect = document.getElementById('inputX');
        const yInput = document.getElementById('inputY');
        const submitButton = document.getElementById('submitButton');
        const radioButtons = document.querySelectorAll('input[name="r"]');
        const form = document.getElementById('mainForm'); 
        const clearButton = document.getElementById('clearButton');

        function checkY() {
            const value = yInput.value;
            const isValid = /^-?\d+(\.\d+)?$/.test(value) && parseFloat(value) >= -5 && parseFloat(value) <= 5;

            if (!isValid) {
                yInput.classList.add('error');
                return false;
            } else {
                yInput.classList.remove('error');
                return true;
            }
        }

        function checkR (){
            let isChecked = false;
        
            for (let i = 0; i < radioButtons.length; i++) {
                if (radioButtons[i].checked) {
                    isChecked = true;
                }
            }
            
            if (!isChecked) {
                for (let i = 0; i < radioButtons.length; i++) {
                    radioButtons[i].classList.add('error');
                }
            } else {
                for (let i = 0; i < radioButtons.length; i++) {
                    radioButtons[i].classList.remove('error');
                }
            }
            
            return isChecked;
        }

        document.addEventListener('DOMContentLoaded', function() {
            
            const savedX = localStorage.getItem('xValue');
            const savedY = localStorage.getItem('yValue');
            const savedR = localStorage.getItem('rValue');
            const savedResults = localStorage.getItem('results');
            
            if (savedX) {
                xSelect.value = savedX;
            }
            if (savedY) {
                yInput.value = savedY;
                checkY(); 
            }
            if (savedR) {
                const radioToCheck = document.querySelector(`input[name="r"][value="${savedR}"]`);
                if (radioToCheck) {
                    radioToCheck.checked = true;
                }
            }
            if (savedResults) {
                document.getElementById('resultsBody').innerHTML = savedResults;
            }
            console.log("загрузил сохраненное" );
            drawGraph(3);
        });

        xSelect.addEventListener('change', function() {
            localStorage.setItem('xValue', xSelect.value); 
        });

        yInput.addEventListener('input', function() {
            
            this.value = this.value.replace(/[^0-9.-]/g, ''); 
            this.value = this.value.replace(/\.\./g, '.'); 
            this.value = this.value.replace(/--/g, '-'); 
            if (this.value.indexOf('-') > 0) {
                this.value = this.value.replace(/-/g, '');
            }

            checkY();
            localStorage.setItem('yValue', yInput.value); 
    
        });

        radioButtons.forEach(radio => {
            radio.addEventListener('change', function() {
                const selectedR = document.querySelector('input[name="r"]:checked');
                if (selectedR) {
                    localStorage.setItem('rValue', selectedR.value); 
                }
            });
        });

    
        form.addEventListener('submit', function (event) {
            event.preventDefault(); 
            const formData = new FormData(form); 
            console.log("Форма отправляется");
            if (checkY() && checkR()){
                
                $.ajax({
                    url: '/fcgi/labwork1',
                    type: 'POST',
                    data: $(this).serialize(), 
                    success: function(response) {
                        
                        toastr.success('Данные успешно отправлены!');

                        console.log("Успешный ответ:", response);
                        
                        let data = response;
                        const x = formData.get('x');
                        const y = formData.get('y');
                        const r = formData.get('r');
                        const answer = data.answer;
                        const workTime = data.workTimeMicros;
                        const now = data.currentTime;
                        const resultsBody = document.getElementById('resultsBody');
                        const svg = document.getElementById("graph");

                        drawGraph(parseFloat(x), parseFloat(y), parseFloat(r));
                        let newRow;
                        if (answer){
                            newRow = `
                                <tr>
                                    <td>${x}</td>
                                    <td>${y}</td>
                                    <td>${r}</td>
                                    <td>Попал✅</td>
                                    <td>${now}</td>
                                    <td>${workTime} μs</td>
                                </tr>
                            `;
                        } else {
                            newRow = `
                                <tr>
                                    <td>${x}</td>
                                    <td>${y}</td>
                                    <td>${r}</td>
                                    <td>Промазал❌</td>
                                    <td>${now}</td>
                                    <td>${workTime} μs</td>
                                </tr>
                            `;
                        }
                        
                        resultsBody.innerHTML = newRow + resultsBody.innerHTML;
                        localStorage.setItem('results', resultsBody.innerHTML); 
                        console.log("сохранил таблицу");
                    },
                    error: function(xhr, status, error) {
                        console.log("Ошибка:", error);
                        toastr.error('Ошибка при отправке данных.');
                    }
                });
            } else {
                console.log("BAD - валидация не пройдена");
                toastr.warning('Пожалуйста, исправьте ошибки в форме.');
            }
        });

        clearButton.addEventListener('click', function () {
            const resultsBody = document.getElementById("resultsBody");
            if (confirm("Вы уверены, что хотите очистить таблицу?")){
                resultsBody.innerHTML = '';
                localStorage.removeItem('results'); 
                console.log("очистил");
            }
        });

        function drawGraph(pointX, pointY, R) {
            const svg = document.getElementById("graph");
            svg.innerHTML = '';  // очистка SVG

            const centerX = 100, centerY = 100, scale = 40; // расстояние между метками = 40px

            function createLine(x1,y1,x2,y2,stroke="black") {
                const line = document.createElementNS("http://www.w3.org/2000/svg","line");
                line.setAttribute("x1",x1); line.setAttribute("y1",y1);
                line.setAttribute("x2",x2); line.setAttribute("y2",y2);
                line.setAttribute("stroke",stroke);
                svg.appendChild(line);
            }

            function createText(x,y,text) {
                const t = document.createElementNS("http://www.w3.org/2000/svg","text");
                t.setAttribute("x",x); t.setAttribute("y",y);
                t.setAttribute("font-size","10px");
                t.textContent = text;
                svg.appendChild(t);
            }

            createLine(0, centerY, 200, centerY);  // X
            createLine(centerX, 0, centerX, 200);  // Y

            ["-R","-R/2","0","R/2","R"].forEach((label,i)=>{
                const x = centerX + (i-2)*scale;
                createLine(x, centerY-4, x, centerY+4);
                createText(x-8, centerY+15, label);
            });

            ["R","R/2","0","-R/2","-R"].forEach((label,i)=>{
                const y = centerY - (i-2)*scale;
                createLine(centerX-4, y, centerX+4, y);
                createText(centerX+8, y+4, label);
            });

            const rect = document.createElementNS("http://www.w3.org/2000/svg","rect");
            rect.setAttribute("x", centerX-40);
            rect.setAttribute("y", centerY-80);
            rect.setAttribute("width", 40);
            rect.setAttribute("height", 80);
            rect.setAttribute("fill","rgba(0,150,255,0.6)");
            rect.setAttribute("stroke","blue");
            svg.appendChild(rect);

            const tri = document.createElementNS("http://www.w3.org/2000/svg","polygon");
            tri.setAttribute("points", `${centerX},${centerY} ${centerX+80},${centerY} ${centerX},${centerY+40}`);
            tri.setAttribute("fill","rgba(0,150,255,0.6)");
            tri.setAttribute("stroke","blue");
            svg.appendChild(tri);

            const arc = document.createElementNS("http://www.w3.org/2000/svg","path");
            arc.setAttribute("d", `M ${centerX-80},${centerY} A 80 80 0 0 0 ${centerX},${centerY+80} L ${centerX},${centerY} Z`);
            arc.setAttribute("fill","rgba(0,150,255,0.6)");
            arc.setAttribute("stroke","blue");
            svg.appendChild(arc);

            if(pointX !== undefined && pointY !== undefined && R !== undefined) {
                const point = document.createElementNS("http://www.w3.org/2000/svg","circle");
                point.setAttribute("cx", 2* pointX * scale/R  + centerX);
                point.setAttribute("cy", - 2* pointY * scale/R + centerY);
                point.setAttribute("r", 3);
                point.setAttribute("fill", "red");
                svg.appendChild(point);
            }
    }
    </script>
</body>
</html>

